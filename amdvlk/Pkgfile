# Description: AMD's standalone Vulkan driver
# URL: https://github.com/GPUOpen-Drivers
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: git vulkan-loader xorg-server wayland

name=amdvlk
version=2019.Q4.2
release=1
source=(https://github.com/GPUOpen-Drivers/AMDVLK/archive/v-$version/$name-$version.tar.gz amdPalSettings.cfg)
git_source=(https://github.com/GPUOpen-Drivers/xgl.git
  https://github.com/GPUOpen-Drivers/llvm.git
  https://github.com/GPUOpen-Drivers/pal.git
  https://github.com/GPUOpen-Drivers/wsa.git
  https://github.com/GPUOpen-Drivers/llpc.git
  https://github.com/GPUOpen-Drivers/MetroHash.git pal/src/util/imported/metrohash
  https://github.com/GPUOpen-Drivers/CWPack.git)

build() {
  cd $PKGMK_SOURCE_DIR
  if cd xgl; then
    git pull --rebase https://github.com/GPUOpen-Drivers/xgl.git
  else
    git clone -b dev https://github.com/GPUOpen-Drivers/xgl.git xgl
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd llvm; then
    git pull --rebase https://github.com/GPUOpen-Drivers/llvm.git
  else
    git clone -b amd-vulkan-dev https://github.com/GPUOpen-Drivers/llvm.git llvm
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd pal; then
    git pull --rebase https://github.com/GPUOpen-Drivers/pal.git
  else
    git clone -b dev https://github.com/GPUOpen-Drivers/pal.git pal
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd wsa; then
    git pull --rebase https://github.com/GPUOpen-Drivers/wsa.git
  else
    git clone -b master https://github.com/GPUOpen-Drivers/wsa.git wsa
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd llpc; then
    git pull --rebase https://github.com/GPUOpen-Drivers/llpc.git
  else
    git clone -b dev https://github.com/GPUOpen-Drivers/llpc.git llpc
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd cwpack; then
    git pull --rebase https://github.com/GPUOpen-Drivers/CWPack.git
  else
    git clone -b amd-master https://github.com/GPUOpen-Drivers/CWPack.git cwpack
    cd ..
  fi
  cd $PKGMK_SOURCE_DIR
  if cd metrohash; then
    git pull --rebase https://github.com/GPUOpen-Drivers/MetroHash.git
  else
    git clone -b amd-master https://github.com/GPUOpen-Drivers/MetroHash.git metrohash
  fi
  cp -r $PKGMK_SOURCE_DIR/{xgl,llvm,pal,wsa,llpc} $SRC
  cp -R $PKGMK_SOURCE_DIR/{metrohash,cwpack} $SRC/pal/src/util/imported/.
  cd $SRC
  sed -i "s/<drm/<libdrm/g" pal/src/core/os/amdgpu/display/displayWindowSystem.h
  cd xgl
  export CFLAGS=${CFLAGS/-fno-plt}
  export CXXFLAGS=${CXXFLAGS/-fno-plt}
  export LDFLAGS=${LDFLAGS/,-z,now}
  cmake -H. -Bbuilds/Release64 \
    -DCMAKE_BUILD_TYPE=Release \
    -DBUILD_WAYLAND_SUPPORT=On \
    -DBUILD_WSA=On
  cd builds/Release64
  make

  install -m755 -d $PKG/usr/lib
  install -m755 -d $PKG/usr/share/vulkan/icd.d
  install -m755 -d $PKG/etc/amd
  install -m644 $SRC/amdPalSettings.cfg $PKG/etc/amd/amdPalSettings.cfg
  cd $SRC
  install xgl/builds/Release64/icd/amdvlk64.so $PKG/usr/lib/
  install AMDVLK-v-$version/json/Redhat/amd_icd64.json $PKG/usr/share/vulkan/icd.d/
  sed -i "s/\/lib64/\/lib/g" $PKG/usr/share/vulkan/icd.d/amd_icd64.json
}
