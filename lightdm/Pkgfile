# Description: Lightweight Desktop Manager prefered by Mate Desktop
# URL: https://freedesktop.org/wiki/Software/LightDM/ 
# Maintainer: Tim Biermann <tim_biermann@web.de>
# Depends on: glib2 glibc gtk-doc libgcrypt linux-pam polkit xorg-libx11 xorg-libxklavier

name=lightdm
version=1.25.2
release=1
source=(https://github.com/CanonicalLtd/lightdm/releases/download/$version/$name-$version.tar.xz Xsession lightdm-default-config.patch lightdm.rules lightdm.service)

build() {
	cd $name-$version
    #patch -Np1 $SRC/lightdm-default-config.patch

    ./configure --prefix='/usr' \
                --localstatedir='/var' \
                --sbindir='/usr/bin' \
                --sysconfdir='/usr/etc' \
		        --enable-liblightdm-qt5=no \
                --with-greeter-user='lightdm' \
                --with-greeter-session='lightdm-mini-greeter' \
                --disable-static \
		        --disable-nls \
                --disable-tests 
                
    make
    make DESTDIR=$PKG install
    
    rm -rf $PKG/usr/etc/init

    #install Xsession wrapper to use with lightdm
    install -m 755 $SRC/Xsession $PKG/usr/etc/lightdm/Xsession

    install -dm 755 $PKG/var/cache/lightdm
    install -dm 770 $PKG/var/lib/lightdm{,-data}
    install -dm 711 $PKG/var/log/lightdm
    chmod +t $PKG/var/{cache/lightdm,lib/lightdm{,-data}}
    chown 620:620 -R $PKG/var/lib/lightdm{,-data}
    chgrp 620 $PKG/var/log/lightdm
    
    #install PAM configurations
    install -d $PKG/etc/pam.d
#	for i in data/pam/*; do
#		install -m 644 $i $PKG/etc/pam.d/$i;
#	done

    cd data/pam
    for i in *; do
        install -m644 $i $PKG/etc/pam.d/;
    done
    cd ../..
#    install -m644 data/pam/{lightdm,lightdm-autologin,lightdm-greeter} $PKG/etc/pam.d
    #luckily we don't use system.d 
    for i in $PKG/etc/pam.d/*; do
    sed -i '/session   optional pam_systemd.so/ c\-session   optional pam_systemd.so' $i; done

    #install PolKit rules
    install -dm 750 -g root $PKG/usr/share/polkit-1/rules.d
    install -m 644 ../lightdm.rules $PKG/usr/share/polkit-1/rules.d/lightdm.rules

    #install rc.d service
    install -dm 755 $PKG/etc/rc.d
    install -m 755 ../lightdm.service $PKG/etc/rc.d/lightdm
    
    #remove junk
    rm -fr $PKG/usr/share/{locale,gtk-doc,help}

}
