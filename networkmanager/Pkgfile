# Description: Network configuration tool
# URL: https://wiki.gnome.org/Projects/NetworkManager/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: dhcpcd libndp libnl nss openresolv polkit upower gconf libnewt
# Optional:    ppp avahi bash-completion dbus libnl jansson libteam dnsmasq

name=networkmanager
version=1.14.4
release=1
source=(
http://ftp.gnome.org/pub/gnome/sources/NetworkManager/${version%.*}/NetworkManager-${version}.tar.xz
networkmanager.rc
NetworkManager.conf
polkit.conf
dhcp.conf
disable_wifi_scan_when_connected.patch
)

build() {
    cd NetworkManager-$version

    patch -Np1 -i ../disable_wifi_scan_when_connected.patch
    sed '/initrd/d' -i src/meson.build
    
    mkdir build
    cd build

    CXXFLAGS+="-O2 -fPIC" \
    meson --prefix /usr \
        --sysconfdir /etc \
        --localstatedir /var \
        -Ddbus_conf_dir=/usr/etc/dbus-1/system.d \
        -Dpolkit_dir=/usr/etc/polkit-1/rules.d \
        -Dudev_dir=/lib/udev \
        -Ddhcpcd=/sbin/dhcpcd \
        -Dresolvconf=true \
        -Dcrypto=nss \
        -Dintrospection=true \
        -Dwifi=true \
        -Dwext=true \
        -Dsession_tracking_consolekit=true \
        -Dpolkit=yes \
        -Dpolkit_agent=true \
        -Dmodify_system=true \
        -Dlibnm_glib=true \
        -Difupdown=true \
        -Dlibaudit=no \
        -Dlibpsl=false \
        -Dnmtui=true \
        -Dppp=false \
        -Dselinux=false \
        -Dsession_tracking=no \
        -Dmodem_manager=false \
        -Dsystemdsystemunitdir=no \
        -Dsystemd_journal=false \
        -Dqt=false \
        -Ddocs=false \
        -Dtests=no \
        -Dmore_logging=false \
        -Dmore_asserts=0 \
        -Dlibpsl=false \
        ..
    
    ninja
    DESTDIR=$PKG ninja install

	# Install config file
	install -D -m 644 -o root -g root $SRC/NetworkManager.conf $PKG/etc/NetworkManager/NetworkManager.conf
	install -D -m 644 -o root -g root $SRC/dhcp.conf $PKG/etc/NetworkManager/conf.d/dhcp.conf
	install -D -m 644 -o root -g root $SRC/polkit.conf $PKG/etc/NetworkManager/conf.d/polkit.conf

	# Install startup script
	install -D -m 755 -o root -g root $SRC/$name.rc $PKG/etc/rc.d/$name

    # Remove rundir etc
	rm -rf $PKG/var/run $PKG/usr/share/{gtk-,}doc $PKG/usr/share/man/man5/nmcli-examples.5 $PKG/usr/share/locale

    # fix polkit folder
    chown -R polkitd:root $PKG/usr/etc/polkit-1/rules.d 
	# Remove bash-completion config unless it's installed
	if [ ! -f /usr/lib/pkgconfig/bash-completion.pc ]; then
		rm -rf $PKG/usr/share/bash-completion
	fi
}
