# Description: An optimized BLAS library based on GotoBLAS2 1.13 BSD
# URL: http://www.openblas.net/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: gcc-fortran

name=openblas
version=0.3.6
release=1
source=(https://github.com/xianyi/OpenBLAS/archive/v$version/$name-$version.tar.gz)

build() {
  cd OpenBLAS-$version
  make NO_STATIC=1 NO_LAPACK=1 NO_LAPACKE=1 \
    NO_CBLAS=1 NO_AFFINITY=1 USE_OPENMP=1 \
    CFLAGS="$CPPFLAGS $CFLAGS" DYNAMIC_ARCH=1 \
    NUM_THREADS=64 MAJOR_VERSION=3 libs shared
  make PREFIX="$PKG"/usr NUM_THREADS=64 MAJOR_VERSION=3 install

  rm -fr $PKG/usr/include/cblas.h $PKG/usr/include/lapacke*
  pushd $PKG/usr/lib
  ln -s libopenblasp-r$version.so libblas.so
  ln -s libopenblasp-r$version.so libblas.so.3
  sed -i -e "s%$PKG%%" $PKG/usr/lib/cmake/openblas/OpenBLASConfig.cmake
  sed -i -e "s%$PKG%%" $PKG/usr/lib/pkgconfig/openblas.pc
  ln -s openblas.pc $PKG/usr/lib/pkgconfig/blas.pc

  rmdir "$PKG"/usr/bin
}
