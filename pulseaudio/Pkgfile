# Description: PulseAudio is a cross-platform, networked sound server
# URL: http://pulseaudio.org/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: dbus intltool libsndfile meson ninja xorg-libxtst
# Optional: avahi bluez fftw glib orc sbc speexdsp

name=pulseaudio
version=13.0
release=2
source=(http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz)

build() {
  cd $name-$version

  [[ -e /usr/lib/pkgconfig/bluez.pc ]] || PKGMK_PULSEAUDIO+=' -Dbluez5=false'
  [[ -e /usr/lib/pkgconfig/xtst.pc ]] || PKGMK_PULSEAUDIO+=' -Dman=false'
  [[ -e /usr/lib/pkgconfig/bash-completion.pc ]] || PKGMK_PULSEAUDIO+=' -Dbashcompletiondir=no'
  [[ -e "/usr/bin/zsh" || -e "/bin/zsh" ]] || PKGMK_PULSEAUDIO+=' -Dzshcompletiondir=no'

  meson . build $PKGMK_PULSEAUDIO \
    --prefix=/usr \
    --libexecdir=/usr/lib/$name \
    -Dudevrulesdir=/etc/udev/rules.d \
    -Ddatabase=gdbm \
    -Dtests=false

  ninja -C build
  DESTDIR=$PKG meson install -C build

  rm -r $PKG/usr/share/locale
  # the meson build seems broken here, no idea why though
  rm -r $PKG/usr/no

  sed -e '/autospawn/iautospawn = no' -i $PKG/etc/pulse/client.conf
  sed -e '/flat-volumes/iflat-volumes = no' -i $PKG/etc/pulse/daemon.conf
  sed -e '/Load several protocols/aload-module module-dbus-protocol' \
    -i $PKG/etc/pulse/default.pa

  mkdir -p $PKG/etc/pulse/{client,daemon}.conf.d
}
