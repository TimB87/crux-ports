# Description: PulseAudio is a cross-platform, networked sound server
# URL: https://www.freedesktop.org/wiki/Software/PulseAudio/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: dbus intltool libsndfile meson ninja xorg-libxtst xorg-libice xorg-libsm
# Optional: avahi bluez fftw glib orc sbc speexdsp

name=pulseaudio
version=14.2
release=1
source=(http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz)

build() {
  [[ -e /usr/lib/pkgconfig/bluez.pc ]] || PKGMK_PULSEAUDIO+=' -Dbluez5=false'
  [[ -e /usr/lib/pkgconfig/xtst.pc ]] || PKGMK_PULSEAUDIO+=' -Dman=false'
  [[ -e /usr/lib/pkgconfig/bash-completion.pc ]] || PKGMK_PULSEAUDIO+=' -Dbashcompletiondir=no'
  [[ -e "/usr/bin/zsh" || -e "/bin/zsh" ]] || PKGMK_PULSEAUDIO+=' -Dzshcompletiondir=no'
  [[ -e /usr/lib/pkgconfig/gstreamer-1.0.pc ]] && PKGMK_PULSEAUDIO+=' -Dgstreamer=enabled'
  [[ -e /usr/lib/pkgconfig/samplerate.pc ]] && PKGMK_PULSEAUDIO+=' -Dsamplerate=enabled'

  meson setup $name-$version build $PKGMK_PULSEAUDIO \
    --prefix=/usr \
    --libexecdir=/usr/lib/$name \
    -D buildtype=plain \
    -D udevrulesdir=/etc/udev/rules.d \
    -D database=gdbm \
    -D tests=false
  meson compile -C build
  DESTDIR=$PKG meson install -C build

  rm -r $PKG/usr/share/locale

  sed -e '/autospawn/iautospawn = no' -i $PKG/etc/pulse/client.conf
  sed -e '/flat-volumes/iflat-volumes = no' -i $PKG/etc/pulse/daemon.conf
  sed -e '/Load several protocols/aload-module module-dbus-protocol' \
    -i $PKG/etc/pulse/default.pa

  mkdir -p $PKG/etc/pulse/{client,daemon}.conf.d
}
