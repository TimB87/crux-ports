# Description: PulseAudio is a cross-platform, networked sound server - with bluez5 support
# URL: http://pulseaudio.org/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Packager: Fredrik Rinnestam, fredrik at crux dot guru
# Depends on: avahi bluez5 libcap libsndfile libtool orc sbc speexdsp tdb util-linux

name=pulseaudio
version=12.2
release=1
source=(http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz disable_flat_volumes.conf)

build() {
    cd $name-$version
    NOCONFIGURE=1 ./bootstrap.sh
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --libexecdir=/usr/lib/$name \
        --disable-nls \
        --disable-esound \
        --disable-x11 \
        --disable-gtk3 \
        --disable-legacy-database-entry-format \
        --disable-hal-compat \
        --disable-tests \
        --disable-bluez4 \
        --disable-rpath \
        --enable-bluez5 \
        --disable-openssl \
        --with-database=tdb
    # fight unused direct deps
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
    make
    make DESTDIR="$PKG" install
    rm -rf $PKG/etc/bash_completion.d
    rm -rf $PKG/usr/share/zsh
    rm -f $PKG/usr/share/man/man1/start-pulseaudio-kde.1
    install -D -m755 src/start-pulseaudio-x11 $PKG/usr/bin/start-pulseaudio-x11
    # Disable cork-request module, can result in e.g. media players unpausing
    # when there's a Skype call incoming
    # thanks to pedja
    sed -e 's|/usr/bin/pactl load-module module-x11-cork-request|#&|' \
        -i $PKG/usr/bin/start-pulseaudio-x11
    mkdir -p $PKG/etc/pulse/client.conf.d
    mkdir -p $PKG/etc/pulse/daemon.conf.d
    install -m 644 $SRC/disable_flat_volumes.conf $PKG/etc/pulse/daemon.conf.d/
}
