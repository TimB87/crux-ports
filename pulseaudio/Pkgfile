# Description:	PulseAudio is a cross-platform, networked sound server - with bluez5 support
# URL:		http://pulseaudio.org/
# Maintainer:	Alan Mizrahi, alan at mizrahi dot com dot ve
# Depends on:	libsndfile speexdsp json-c dbus p5-xml-parser glib
# Optional:	libsamplerate bluez avahi sbc orc lirc pyqt4 sbc sbc

name=pulseaudio
version=11.1
release=3
source=(http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz)

build() {
	cd $name-$version
	./configure \
		--prefix=/usr \
		--libexecdir=/usr/lib/pulseaudio/libexec \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-nls \
		--disable-esound \
		--disable-x11 \
		--disable-gtk3 \
		--disable-oss-output \
		--disable-oss-wrapper \
		--disable-legacy-database-entry-format \
		--disable-hal-compat \
		--with-database=tdb \
		--disable-tests \
		--disable-bluez4 \
		--disable-samplerate \
		--disable-rpath \
		--enable-bluez5
	# fight unused direct deps
	sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

	make
	make DESTDIR="$PKG" install

	# Workaround the /usr/etc CRUX oddity
	mkdir $PKG/usr/etc
	mv $PKG/etc/dbus-1 $PKG/usr/etc

	rm -rf $PKG/etc/bash_completion.d
	rm -f $PKG/usr/share/man/man1/start-pulseaudio-kde.1

	install -D -m755 src/start-pulseaudio-x11 $PKG/usr/bin/start-pulseaudio-x11
	#modules
	
#  mkdir -p $SRC/bluetooth/usr/lib/pulse-/modules \
#           $SRC/{gconf/usr/lib/pulse,equalizer/usr/bin}	
#	  mv usr/lib/pulse-$_pulsever/modules/{libbluez5-util,module-{bluetooth-{discover,policy},bluez5-{discover,device}}}.so \
#     "$srcdir/bluetooth/usr/lib/pulse-$_pulsever/modules"

	# If proximity helper was installed, remove setuid bit
	# To use capabilities instead of the setuid bit, run:
	# setcap cap_net_raw=ep /usr/lib/pulseaudio/libexec/pulse/proximity-helper
	if [ -x $PKG/usr/lib/pulseaudio/libexec/pulse/proximity-helper ]; then
		 chmod -s $PKG/usr/lib/pulseaudio/libexec/pulse/proximity-helper
	fi

	# remove zsh completion functions
	rm -rf $PKG/usr/share/zsh

	# Remove bash-completion config unless it's installed
	if [ ! -f /usr/lib/pkgconfig/bash-completion.pc ]; then
		rm -rf $PKG/usr/share/bash-completion
	fi
}
