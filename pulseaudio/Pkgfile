# Description: PulseAudio is a cross-platform, networked sound server - with bluez5 support
# URL: http://pulseaudio.org/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Packager: Fredrik Rinnestam, fredrik at crux dot guru
# Depends on: intltool libsndfile dbus
# Optional: avahi bluez fftw glib sbc speexdsp orc

name=pulseaudio
version=12.2
release=2
source=(http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz)

build() {
  cd $name-$version
  NOCONFIGURE=1 ./bootstrap.sh

  ./configure $PKGMK_PULSEAUDIO \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libexecdir=/usr/lib/$name \
    --disable-{bluez4,default-build-tests,esound,gtk3,hal-compat} \
    --disable-{nls,rpath,samplerate,openssl,tcpwrap,tests,x11} \
    --with-database=gdbm
  # fight unused direct deps
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make
  make -j1 DESTDIR=$PKG install

  if ! pkginfo -i | grep '^bash-completion '; then
    rm -r $PKG/usr/share/bash-completion
  fi
  if ! pkginfo -i | grep '^zsh '; then
    rm -r $PKG/usr/share/zsh
  fi
  #rm -r $PKG/usr/share/man/man1/start-pulseaudio-kde.1*
  #rm -r $PKG/usr/share/man/man1/start-pulseaudio-x11.1.gz

  sed -e '/autospawn/iautospawn = no' -i $PKG/etc/pulse/client.conf
  sed -e '/flat-volumes/iflat-volumes = no' -i $PKG/etc/pulse/daemon.conf
  sed -e '/Load several protocols/aload-module module-dbus-protocol' \
    -i $PKG/etc/pulse/default.pa

  mkdir -p $PKG/etc/pulse/{client,daemon}.conf.d
}
