# Description: Zotero is a free, easy-to-use tool to help you collect, organize, cite, and share research
# URL: https://www.zotero.org/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: dbus-glib fakeroot git gtk gtk3 npm nss xorg-libxt

name=zotero
version=5.0.66
release=1
source=(zotero.desktop)
git_source=(https://github.com/zotero/zotero zotero-client)
git_build=(https://github.com/zotero/zotero-build)
git_standalonebuild=(https://github.com/zotero/zotero-standalone-build)

build() {
    git clone --recursive $git_source $name-client
    git clone --recursive $git_build $name-build
    git clone --recursive $git_standalonebuild $name-standalone-build
    cd $name-client
    #this needs a fix
    git checkout 8cadbe7 .
    fakeroot npm i
    npm run build
    cd ../zotero-standalone-build
    #this needs a fix as well
    git checkout 528162e .
    ./fetch_xulrunner.sh -p l
    ./fetch_pdftools
    scripts/dir_build
    install -dDm755 $PKG/usr/{bin,lib/zotero}
    mv staging/Zotero_linux-x86_64/* $PKG/usr/lib/zotero
    ln -s /usr/lib/zotero/zotero $PKG/usr/bin/zotero
    install -Dm644 $SRC/zotero.desktop $PKG/usr/share/applications/zotero.desktop
    # Copy zotero icons to a standard location
    install -Dm644 $PKG/usr/lib/zotero/chrome/icons/default/default16.png $PKG/usr/share/icons/hicolor/16x16/apps/zotero.png
    install -Dm644 $PKG/usr/lib/zotero/chrome/icons/default/default32.png $PKG/usr/share/icons/hicolor/32x32/apps/zotero.png
    install -Dm644 $PKG/usr/lib/zotero/chrome/icons/default/default48.png $PKG/usr/share/icons/hicolor/48x48/apps/zotero.png
    install -Dm644 $PKG/usr/lib/zotero/chrome/icons/default/default256.png $PKG/usr/share/icons/hicolor/256x256/apps/zotero.png
    # Disable APP update
    sed -i '/pref("app.update.enabled", true);/c\pref("app.update.enabled", false);' $PKG/usr/lib/zotero/defaults/preferences/prefs.js
    #clean up
    find $PKG \(\
        -iname '*README*' -o \
        -iname '*COPYING*' -o \
        -iname '*README*' \
        \) -delete || true
}
