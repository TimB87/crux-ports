# Description: Very powerfull shell
# URL: http://www.zsh.org/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: libpcre

name=zsh
version=5.8
release=3
source=(https://www.zsh.org/pub/$name-$version.tar.xz _prt-get zsh-lovers.1)

build() {
  cd $name-$version

  # fix paths https://crux.nu/bugs/index.php?getfile=539
  sed -i 's#/usr/share/keymaps#/usr/share/kbd/keymaps#g' Completion/Unix/Command/_loadkeys
  sed -i 's#/usr/share/misc/usb.ids#/usr/share/usb.ids#g' Completion/Linux/Command/_lsusb

  for _fpath in AIX Cygwin Darwin Debian Mandriva openSUSE Redhat Solaris; do
    rm -rf Completion/$_fpath
    sed 's#\s*Completion/$_fpath/\*/\*##g' -i Src/Zle/complete.mdd
  done
  rm -f  Completion/Linux/Command/_{pkgtool,rpmbuild,yast}
  rm -f  Completion/Unix/Command/_{osc,systemd}

  ./configure \
    --prefix=/usr \
    --exec-prefix=/ \
    --enable-etcdir=/etc/zsh \
    --enable-zshrc=/etc/zsh/zshrc \
    --enable-zlogin=/etc/zsh/zshlogin \
    --enable-zlogout=/etc/zsh/zshlogout \
    --enable-zshenv=/etc/zsh/zshenv \
    --enable-zprofile=/etc/zsh/zprofile \
    --enable-fndir=/usr/share/zsh/$version/functions \
    --enable-site-fndir=/usr/share/zsh/site-functions \
    --enable-maildir-support \
    --with-term-lib='ncursesw' \
    --with-tcsetpgrp \
    --enable-function-subdirs \
    --enable-pcre \
    --enable-restricted-r \
    --enable-cap \
    --enable-multibyte \
    --enable-zsh-secure-free

  # fix a bug in recent glibc versions (2.16)
  sed -e '/#include "attr.mdh"/d;/#include "attr.pro/d' \
    -e 's|\(#include <sys/xattr.h>\)|\1\n#include "attr.mdh"\n#include "attr.pro"|g' \
    -i Src/Modules/attr.c

  make
  make DESTDIR=$PKG install

  install -m 644 $SRC/zsh-lovers.1 $PKG/usr/share/man/man1/

  rm $PKG/usr/share/man/man1/zshall.1
  cat $PKG/usr/share/man/man1/* > $PKG/usr/share/man/man1/zshall.1

  # These completion files break things for CRUX' pkgutils,
  # so remove them for now (see bug #381).
  rm $PKG/usr/share/zsh/$version/functions/Completion/Unix/_pkg{add,rm,info}

  install -m 644 -t $PKG/usr/share/zsh/site-functions $SRC/_prt-get
}
